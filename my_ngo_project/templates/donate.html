{% extends 'base.html' %}
{% load static %}

{% block title %}Donate | MESCO{% endblock %}

{% block content %}
{% include 'breadcrumb.html' %}

<div class="donation-form section-padding">
    <div class="container">
        <div class="row">
            <div class="col-lg-8">
                <div class="card-style box-shadow border-0">
                    <div class="card-body">
                        <div class="small-tittle mb-50">
                            <h2 class="title text-capitalize font-600 position-relative">Donation Form</h2>
                        </div>
                        <p>If you have already donated before, enter your Email ID or Mobile No. The remaining details will be filled automatically.</p>
                        
                        <form id="donationForm" method="post">
                            {% csrf_token %}
                            
                            <div class="mb-3">
                                <label for="emailOrMobile" class="form-label">Enter Email / Mobile To Fill The Data</label>
                                <input type="text" class="form-control" id="emailOrMobile" name="emailOrMobile">
                                <p id="alertMessage" style="display: none; color: red;">No donor found with this email or mobile number. Please fill in your details.</p>
                                <button type="button" class="btn btn-secondary mt-2" id="fillDataBtn">Fill Data</button>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Zakat</label>
                                <select class="form-select" name="is_zakat" id="is_zakat">
                                    <option value="yes">Yes</option>
                                    <option value="no">No</option>
                                </select>
                            </div>

                            <div class="mb-4">
                                <h3 class="font-400 position-relative mb-2">Select Donation Options</h3>
                                <ul class="selectPricing mb-20">
                                    <li class="listItem" data-amount="25000" data-purpose="EAS">
                                        <span class="donation-description"><b>RS.25,000</b> - Sponsor 1 child to Complete the Education After Std VII for 1 year.(EAS)</span>
                                        <div class="quantity-controls">
                                            <button type="button" class="btn btn-sm btn-outline-secondary decrement">-</button>
                                            <span class="quantity">0</span>
                                            <button type="button" class="btn btn-sm btn-outline-secondary increment">+</button>
                                        </div>
                                    </li>
                                    <li class="listItem" data-amount="8000" data-purpose="STVC">
                                        <span class="donation-description"><b>RS.8,000</b> - Sponsor 1 child to Complete their Technical Education for 1 year.(STVC)</span>
                                        <div class="quantity-controls">
                                            <button type="button" class="btn btn-sm btn-outline-secondary decrement">-</button>
                                            <span class="quantity">0</span>
                                            <button type="button" class="btn btn-sm btn-outline-secondary increment">+</button>
                                        </div>
                                    </li>
                                    <li class="listItem" data-amount="700" data-purpose="Per Dialysis Cost">
                                        <span class="donation-description"><b>RS. 700</b> - Sponsor 1 Dialysis Patient for Per Dialysis Cost</span>
                                        <div class="quantity-controls">
                                            <button type="button" class="btn btn-sm btn-outline-secondary decrement">-</button>
                                            <span class="quantity">0</span>
                                            <button type="button" class="btn btn-sm btn-outline-secondary increment">+</button>
                                        </div>
                                    </li>
                                    <li class="listItem" data-amount="50000" data-purpose="Higher Education">
                                        <span class="donation-description"><b>RS.50,000</b> - Sponsor 1 child to Complete the Higher Education for 1 year. (HCES)</span>
                                        <div class="quantity-controls">
                                            <button type="button" class="btn btn-sm btn-outline-secondary decrement">-</button>
                                            <span class="quantity">0</span>
                                            <button type="button" class="btn btn-sm btn-outline-secondary increment">+</button>
                                        </div>
                                    </li>
                                    <li class="listItem" data-amount="9000" data-purpose="Sewing Machine">
                                        <span class="donation-description"><b>RS.9,000</b> - Sponsor 1 Sewing Machine to Widow to become Self Sufficient</span>
                                        <div class="quantity-controls">
                                            <button type="button" class="btn btn-sm btn-outline-secondary decrement">-</button>
                                            <span class="quantity">0</span>
                                            <button type="button" class="btn btn-sm btn-outline-secondary increment">+</button>
                                        </div>
                                    </li>
                                    <li class="listItem" data-amount="8000" data-purpose="Education">
                                        <span class="donation-description"><b>RS.8,000</b> - Sponsor 1 child to Complete their Education for 1year. (EAID)</span>
                                        <div class="quantity-controls">
                                            <button type="button" class="btn btn-sm btn-outline-secondary decrement">-</button>
                                            <span class="quantity">0</span>
                                            <button type="button" class="btn btn-sm btn-outline-secondary increment">+</button>
                                        </div>
                                    </li>
                                    <li class="listItem" data-amount="28000" data-purpose="Dry Ration">
                                        <span class="donation-description"><b>RS.28,000</b> - Sponsor 1 Family for dry Ration for 1 year.</span>
                                        <div class="quantity-controls">
                                            <button type="button" class="btn btn-sm btn-outline-secondary decrement">-</button>
                                            <span class="quantity">0</span>
                                            <button type="button" class="btn btn-sm btn-outline-secondary increment">+</button>
                                        </div>
                                    </li>
                                    <li class="listItem" data-amount="15000" data-purpose="Monthly Medicines">
                                        <span class="donation-description"><b>RS.15,000</b> - Support 1 Patient for Monthly Medicines for chronic illness.(MA)</span>
                                        <div class="quantity-controls">
                                            <button type="button" class="btn btn-sm btn-outline-secondary decrement">-</button>
                                            <span class="quantity">0</span>
                                            <button type="button" class="btn btn-sm btn-outline-secondary increment">+</button>
                                        </div>
                                    </li>
                                    <li class="listItem" data-amount="30000" data-purpose="Life Saving Surgeries">
                                        <span class="donation-description"><b>RS. 30,000</b> - Support 1 Patient for Life Saving surgeries (LSMA)</span>
                                        <div class="quantity-controls">
                                            <button type="button" class="btn btn-sm btn-outline-secondary decrement">-</button>
                                            <span class="quantity">0</span>
                                            <button type="button" class="btn btn-sm btn-outline-secondary increment">+</button>
                                        </div>
                                    </li>
                                    <li class="listItem" data-amount="8400" data-purpose="Per Month Dialysis Cost">
                                        <span class="donation-description"><b>RS.8,400</b>- Sponsor 1 Dialysis Patient for Per month Dialysis Cost.</span>
                                        <div class="quantity-controls">
                                            <button type="button" class="btn btn-sm btn-outline-secondary decrement">-</button>
                                            <span class="quantity">0</span>
                                            <button type="button" class="btn btn-sm btn-outline-secondary increment">+</button>
                                        </div>
                                    </li>
                                    <li class="listItem" data-amount="500" data-purpose="Payroll Giving">
                                        <span class="donation-description"><b>RS.500</b> - Participate in Payroll giving programme per month.</span>
                                        <div class="quantity-controls">
                                            <button type="button" class="btn btn-sm btn-outline-secondary decrement">-</button>
                                            <span class="quantity">0</span>
                                            <button type="button" class="btn btn-sm btn-outline-secondary increment">+</button>
                                        </div>
                                    </li>
                                    <li class="listItem" data-amount="other" data-purpose="Other">Others</li>
                                </ul>
                                <input type="number" class="form-control mt-2" id="otherAmount" placeholder="Enter amount" style="display: none;">
                            </div>

                            <div class="mb-3">
                                <label for="surname" class="form-label">Surname</label>
                                <input type="text" class="form-control" id="surname" name="surname" maxlength="100" required>
                            </div>

                            <div class="mb-3">
                                <label for="firstName" class="form-label">First Name</label>
                                <input type="text" class="form-control" id="firstName" name="firstName" maxlength="100" required>
                            </div>
                            
                            <div class="mb-3">
                                <label for="middleName" class="form-label">Middle Name</label>
                                <input type="text" class="form-control" id="middleName" name="middleName" maxlength="100">
                            </div>
                            
                            <div class="mb-3">
                                <label for="panNo" class="form-label">PAN No</label>
                                <input type="text" class="form-control" id="panNo" name="panNo" pattern="[A-Z]{5}[0-9]{4}[A-Z]{1}" title="Enter a valid PAN number" required>
                            </div>

                            <div class="mb-3">
                                <label for="email" class="form-label">Email</label>
                                <input type="email" class="form-control" id="email" name="email" required>
                            </div>

                            <div class="mb-3">
                                <label for="mobile" class="form-label">Mobile</label>
                                <input type="tel" class="form-control" id="mobile" name="mobile" pattern="[0-9]{10}" title="Enter a 10-digit mobile number" required>
                            </div>

                            <div class="mb-3">
                                <label for="dofficial" class="form-label">Dofficial</label>
                                <input type="text" class="form-control" id="dofficial" name="dofficial" maxlength="100">
                            </div>

                            <div class="mb-3">
                                <label for="address" class="form-label">Address</label>
                                <textarea class="form-control" id="address" name="address" rows="3" maxlength="500" required></textarea>
                            </div>

                            <div class="mb-3">
                                <label for="city" class="form-label">City</label>
                                <input type="text" class="form-control" id="city" name="city" maxlength="100" required>
                            </div>

                            <div class="mb-3">
                                <label for="country" class="form-label">Country</label>
                                <input type="text" class="form-control" id="country" name="country" maxlength="100" required>
                            </div>

                            <div class="mb-3">
                                <label for="state" class="form-label">State</label>
                                <input type="text" class="form-control" id="state" name="state" maxlength="100" required>
                            </div>

                            <div class="mb-3">
                                <label for="pincode" class="form-label">Pincode</label>
                                <input type="text" class="form-control" id="pincode" name="pincode" pattern="[0-9]{6}" title="Enter a 6-digit pincode" required>
                            </div>

                            <div class="mb-3">
                                <label for="amount" class="form-label">Total Amount</label>
                                <input type="text" class="form-control" id="amount" name="amount" readonly>
                            </div>

                            <div class="mb-3">
                                <label for="purpose" class="form-label">Purpose</label>
                                <input type="text" class="form-control" id="purpose" name="purpose" readonly>
                            </div>

                            <div class="mb-3">
                                <label for="notes" class="form-label">Notes</label>
                                <textarea class="form-control" id="notes" name="notes" rows="3" maxlength="1000"></textarea>
                            </div>

                            <button id="rzp-button" type="button" class="btn btn-primary mt-3 mb-3">Pay with Razorpay</button>
                        </form>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="sticky-sidebar">
                    <div class="paymentDetails card-style box-shadow border-0 mb-24">
                        <div class="blog-info">
                            <div class="blog-info-title">
                                <h4 class="title text-capitalize">Selected Donations</h4>
                                <div class="priceListing">
                                    <ul class="listing" id="selectedDonations">
                                        <!-- Selected donations will be displayed here -->
                                    </ul>
                                </div>
                                <div class="total-amount">
                                    <h5 class="leftCap font-600">Total Amount:</h5>
                                    <h5 class="rightCap total_donation_amount font-600" id="totalAmount">RS. 0</h5>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tax-exemption-info">
                        Your Donation to MESCO Exempt Under Section 80G of Income Tax Act 1961.
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('donationForm');
    const donationOptions = document.querySelectorAll('.selectPricing .listItem');
    const otherAmountInput = document.getElementById('otherAmount');
    const selectedDonationsUl = document.getElementById('selectedDonations');
    const totalAmountSpan = document.getElementById('totalAmount');
    const amountInput = document.getElementById('amount');
    const purposeInput = document.getElementById('purpose');
    const rzpButton = document.getElementById('rzp-button');

    function sanitizeInput(input) {
        return input.replace(/[&<>"']/g, function(m) {
            return {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            }[m];
        });
    }

    function escapeHtml(unsafe) {
        return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")
                     .replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    function updateSelectedDonations() {
        let total = 0;
        let html = '';
        let purposes = [];

        donationOptions.forEach(option => {
            const amount = parseInt(option.dataset.amount) || 0;
            const purpose = escapeHtml(option.dataset.purpose);
            const quantity = parseInt(option.querySelector('.quantity')?.textContent) || 0;

            if (quantity > 0 && option.dataset.amount !== 'other') {
                const subtotal = amount * quantity;
                html += `<li class="listItem"><p class="leftCap">${purpose} x${quantity}</p><p class="rightCap">RS. ${subtotal}</p></li>`;
                total += subtotal;
                purposes.push(`${purpose} (x${quantity})`);
            }
            // Update the color based on quantity
            if (quantity > 1) {
                option.classList.add('selected-multiple');
            } else if (quantity === 1) {
                option.classList.add('selected');
                option.classList.remove('selected-multiple');
            } else {
                option.classList.remove('selected', 'selected-multiple');
            }
        });

        if (otherAmountInput.style.display !== 'none') {
            const otherAmount = parseInt(otherAmountInput.value) || 0;
            if (otherAmount > 0) {
                html += `<li class="listItem"><p class="leftCap">Other</p><p class="rightCap">RS. ${otherAmount}</p></li>`;
                total += otherAmount;
                purposes.push('Other');
            }
        }

        selectedDonationsUl.innerHTML = html;
        totalAmountSpan.textContent = `RS. ${total}`;
        amountInput.value = total;
        purposeInput.value = purposes.join(', ');
    }

    donationOptions.forEach(option => {
        const incrementBtn = option.querySelector('.increment');
        const decrementBtn = option.querySelector('.decrement');
        const quantitySpan = option.querySelector('.quantity');

        if (incrementBtn && decrementBtn && quantitySpan) {
            incrementBtn.addEventListener('click', function(e) {
                e.preventDefault();
                quantitySpan.textContent = (parseInt(quantitySpan.textContent) || 0) + 1;
                updateSelectedDonations();
            });

            decrementBtn.addEventListener('click', function(e) {
                e.preventDefault();
                const currentQuantity = parseInt(quantitySpan.textContent) || 0;
                if (currentQuantity > 0) {
                    quantitySpan.textContent = currentQuantity - 1;
                    updateSelectedDonations();
                }
            });
        }

        if (option.dataset.amount === 'other') {
            option.addEventListener('click', function(e) {
                e.preventDefault();
                otherAmountInput.style.display = otherAmountInput.style.display === 'none' ? 'block' : 'none';
                updateSelectedDonations();
            });
        }
    });

    otherAmountInput.addEventListener('input', updateSelectedDonations);

    {% if user.is_authenticated %}
    // If user is authenticated, fetch their data automatically
    fetchDonorData('{{ user.email|escapejs }}');
    {% endif %}

    // Load Razorpay script dynamically
    const script = document.createElement('script');
    script.src = 'https://checkout.razorpay.com/v1/checkout.js';
    script.async = true;
    script.onload = initializeRazorpay;
    document.body.appendChild(script);

    function initializeRazorpay() {
        rzpButton.addEventListener('click', function(e) {
            e.preventDefault();
            if (!validateForm()) {
                alert('Please fill in all required fields before proceeding to payment.');
                return;
            }
            const amount = parseFloat(amountInput.value) || 0;
            
            // Prepare the form data
            const formData = new FormData(form);
            const jsonData = {};
            for (let [key, value] of formData.entries()) {
                jsonData[key] = value;
            }
            jsonData.amount = amount;

            // Ensure these fields are included even if empty
            ['firstName', 'middleName', 'panNo'].forEach(field => {
                if (!jsonData[field]) {
                    jsonData[field] = '';
                }
            });

            console.log('Form data being sent:', jsonData); // Add this line for debugging

            // Send data to server to create Razorpay order
            fetch('{% url "create_razorpay_order" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify(jsonData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.order_id) {
                    var options = {
                        "key": "{{ LS6VdH6RC8Rrav }}",
                        "amount": data.amount,
                        "currency": data.currency,
                        "name": "MESCO",
                        "description": "Donation to MESCO",
                        "order_id": data.order_id,
                        "handler": function (response){
                            // Send the payment details to the server
                            fetch('{% url "razorpay_callback" %}', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': '{{ csrf_token }}'
                                },
                                body: JSON.stringify({
                                    razorpay_payment_id: response.razorpay_payment_id,
                                    razorpay_order_id: response.razorpay_order_id,
                                    razorpay_signature: response.razorpay_signature
                                })
                            })
                            .then(response => response.json())
                            .then(data => {
                                if (data.status === 'success') {
                                    window.location.href = '{% url "donation_success" %}';
                                } else {
                                    alert('Payment failed: ' + data.message);
                                    window.location.href = '{% url "donation_failure" %}';
                                }
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                alert('An error occurred. Please check the console and try again.');
                            });
                        },
                        "prefill": {
                            "name": document.getElementById('firstName').value + ' ' + document.getElementById('surname').value,
                            "email": document.getElementById('email').value,
                            "contact": document.getElementById('mobile').value
                        },
                        "theme": {
                            "color": "#F37254"
                        }
                    };
                    var rzp = new Razorpay(options);
                    rzp.open();
                } else {
                    alert('Error creating Razorpay order: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred. Please check the console and try again.');
            });
        });
    }

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        if (validateForm()) {
            this.submit();
        }
    });


    function validateForm() {
        let isValid = true;
        const requiredFields = form.querySelectorAll('[required]');
        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                isValid = false;
                field.classList.add('is-invalid');
            } else {
                field.classList.remove('is-invalid');
            }
        });
        const emailField = form.querySelector('#email');
        if (emailField && !isValidEmail(emailField.value)) {
            isValid = false;
            emailField.classList.add('is-invalid');
        }

        const mobileField = form.querySelector('#mobile');
        if (mobileField && !isValidMobile(mobileField.value)) {
            isValid = false;
            mobileField.classList.add('is-invalid');
        }

        if (!isValid) {
            alert('Please fill in all required fields correctly.');
        }

        return isValid;
    }
    function isValidEmail(email) {
        const re = /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*$/;
        return re.test(email);
    }

    function isValidMobile(mobile) {
        return /^[0-9]{10}$/.test(mobile);
    }

function fetchDonorData(identifier) {
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    fetch(`/api/donor-data/?identifier=${encodeURIComponent(identifier)}`, {
        method: 'GET',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        },
        credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            fillFormData(data.donor, data.isAuthenticated);
            if (!data.isAuthenticated) {
                showAlert('Donor data loaded. Please enter your PAN number manually for security reasons.');
            }
        } else {
            showAlert('No donor found with this email or mobile number. Please fill in your details.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('An error occurred while fetching donor data. Please try again.');
    });
}

function fillFormData(data, isAuthenticated) {
    Object.keys(data).forEach(key => {
        const input = document.getElementById(key);
        if (input) {
            if (key === 'panNo') {
                if (isAuthenticated && data[key]) {
                    input.value = data[key];
                } else {
                    input.value = '';
                    input.placeholder = 'Enter PAN number for security reasons';
                }
            } else {
                input.value = data[key] || '';
            }
        }
    });
}

function showAlert(message) {
        const alertMessage = document.getElementById('alertMessage');
        alertMessage.textContent = message;
        alertMessage.style.display = 'block';
    }

const emailOrMobileInput = document.getElementById('emailOrMobile');
const fillDataBtn = document.getElementById('fillDataBtn');

if (fillDataBtn) {
        fillDataBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const identifier = emailOrMobileInput.value.trim();
            if (identifier) {
                fetchDonorData(identifier);
            } else {
                alert('Please enter an email or mobile number.');
            }
        });
    }

    {% if user.is_authenticated %}
    fetchDonorData('{{ user.email|escapejs }}');
    {% endif %}
});
</script>

{% endblock %}